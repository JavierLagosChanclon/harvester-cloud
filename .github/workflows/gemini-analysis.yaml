name: K8s Gemini Analysis

on:
  workflow_dispatch:
    inputs:
      kubeconfig_base64:
        description: 'Kubeconfig on Base64'
        required: true

jobs:
  analyze-cluster:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install kubectl
        uses: azure/setup-kubectl@v4
      - name: Setup Kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ inputs.kubeconfig_base64 }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
      - name: Run Kubectl Commands
        run: |
          echo -e "\n=== NODES ===" > analysis.txt
          kubectl get nodes -o wide --show-labels >> analysis.txt

          echo -e "\n=== ALL PODS ===" >> analysis.txt
          kubectl get pods -A | grep -v "Running\|Completed" >> analysis.txt

      - name: Load Logs to Env
        run: |
          {
            echo 'K8S_LOGS<<EOF'
            cat analysis.txt
            echo EOF
          } >> $GITHUB_ENV
      - name: Run Performance Pod Debug
        run: |
          echo "=== Detecting first node ==="
          NODE_NAME=$(kubectl get nodes --no-headers --sort-by=.metadata.creationTimestap | awk '{print $1}' | tail -n1)
          echo "Target node: $NODE_NAME"

          echo "=== Creating debug pod ==="
          kubectl debug node/$NODE_NAME --image=docker.io/jlagossuse/custom-performance-harvester-image -- bash -c "cp /tmp/performance.sh /host/tmp/performance.sh && chmod +x /host/tmp/performance.sh && chroot /host bash /tmp/performance.sh" --restart=Never --quiet

          POD_NAME=""
          while [ -z "$POD_NAME" ]; do
            POD_NAME=$(kubectl get pods --no-headers --sort-by=.metadata.creationTimestamp | grep $NODE_NAME | awk '{print $1}' | tail -n1)
            sleep 2
          done
          echo "Debug pod name: $POD_NAME"

          echo "Waiting for pod $POD_NAME to complete..."
          while true; do
            STATUS=$(kubectl get pod $POD_NAME -o jsonpath='{.status.phase}')
            if [ "$STATUS" == "Succeeded" ] || [ "$STATUS" == "Failed" ]; then
              echo "Pod completed with status: $STATUS"
              break
            fi
            sleep 5
          done

          kubectl logs $POD_NAME >> performance_logs.txt

      - name: Load Performance logs to Env
        run: |
          {
            echo 'PERF_LOGS<<EOF'
            cat performance_logs.txt
            echo EOF
          } >> $GITHUB_ENV

      - name: Analyze with Gemini
        uses: google-github-actions/run-gemini-cli@v0
        id: gemini_analysis
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            Please act as an SRE Senior expert in Kubernetes and cloud-native.
            Analyze the state of the cluster and answer in the following format.
            1 Problems detected
            2 Main reason of the problems
            3 Impact from 1 to 5
            4 Specific steps required to fix the issue
            
            Logs:
            ---
            ${{ env.K8S_LOGS }}
            
            Performance node logs:
            ${{ env.PERF_LOGS }}
      - name: Publish Report
        if: always()
        run: |
          echo "## ðŸ¤– Gemini K8s Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.gemini_analysis.outputs.output }}" >> $GITHUB_STEP_SUMMARY            
